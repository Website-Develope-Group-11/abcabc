<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Pin Pictures</title>
    <style type="text/css">
        div.nav {
            border: 1px solid skyBlue;
            margin-left: 3px;
            padding: 3px;
            float: left;
        }

        input,
        p,
        li {
            font-family: Helvetica, "Microsoft YaHei", "LiHei Pro", TW-Kai;
        }

        li {
            font-size: 12px;
        }

        img.picture {
            position: absolute;
        }
    </style>
    <script type="text/javascript">
        window.onload = function () 
        {
            const STORAGE_KEY = "dora_board_items";
            const pinImages = ["red.png", "blue.png", "yellow.png"];
            const accessoryImages = 
            [
                null,        
                "01.png",    
                "02.png",    
                "03.png",    
                "04.png",    
                "05.png",    
                "06.png",    
                "07.png",    
                "08.png",    
                "09.png",    
                "10.png"     
            ];

            const addButton = document.getElementById("addButton");
            const removeAllButton = document.getElementById("removeAllButton");
            const board = document.getElementById("board");

            let items = [];       
            let currentZ = 2;    
            let nextId = 1;       

            function clamp(v, min, max) 
            {
                if (v < min) return min;
                if (v > max) return max;
                return v;
            }

            function saveToStorage() 
            {
                try 
                {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                } 
                catch (e) {}
            }

            function loadFromStorage() 
            {
                let data = null;
                try 
                {
                    data = localStorage.getItem(STORAGE_KEY);
                } 
                catch (e) 
                {
                    data = null;
                }
                if (!data) return;

                try {
                    const arr = JSON.parse(data);
                    if (!Array.isArray(arr)) return;

                    items = arr;
                    currentZ = 2;
                    nextId = 1;

                    for (let i = 0; i < items.length; i++) 
                    {
                        const it = items[i];

                        if (typeof it.id !== "number") 
                        {
                            it.id = nextId;
                        }
                        if (typeof it.z !== "number") 
                        {
                            it.z = 2 + i;
                        }

                        if (it.id >= nextId) nextId = it.id + 1;
                        if (it.z > currentZ) currentZ = it.z;

                        createItemElement(it);
                    }
                } 
                catch (e) 
                {
                    items = [];
                }
            }

            function createItemElement(item) 
            {
                const img = document.createElement("img");
                img.className = "picture accessory";
                img.id = "img-" + item.id;
                img.src = accessoryImages[item.pic];
                img.style.width = "200px";
                img.style.height = "200px";
                img.style.left = item.x + "px";
                img.style.top = item.y + "px";
                img.style.zIndex = item.z;

                const pin = document.createElement("img");
                pin.className = "picture pinAccessory";
                pin.id = "pin-" + item.id;
                pin.src = item.pin;
                pin.style.width = "30px";
                pin.style.left = (item.x + 85) + "px";
                pin.style.top = (item.y - 10) + "px";
                pin.style.zIndex = item.z;

                document.body.appendChild(img);
                document.body.appendChild(pin);

                makeDraggable(item);
            }

            function addNewPicture(picNo, x, y) 
            {
                if (picNo < 1 || picNo > 10) return;
                const pinSrc = pinImages[Math.floor(Math.random() * pinImages.length)];
                const z = ++currentZ;
                const id = nextId++;

                const item = 
                {
                    id: id,
                    pic: picNo,
                    x: x,
                    y: y,
                    pin: pinSrc,
                    z: z
                };

                items.push(item);
                createItemElement(item);
                saveToStorage();
            }

            function makeDraggable(item) 
            {
                const img = document.getElementById("img-" + item.id);
                const pin = document.getElementById("pin-" + item.id);
                if (!img || !pin) return;

                let isDragging = false;
                let offsetX = 0;
                let offsetY = 0;

                img.addEventListener("mousedown", function (e) 
                {
                    e.preventDefault();
                    isDragging = true;

                    currentZ++;
                    img.style.zIndex = currentZ;
                    pin.style.zIndex = currentZ;
                    item.z = currentZ;

                    const rect = img.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;

                    document.addEventListener("mousemove", onMouseMove);
                    document.addEventListener("mouseup", onMouseUp);
                });

                function onMouseMove(e) 
                {
                    if (!isDragging) return;

                    const boardRect = board.getBoundingClientRect();

                    let newLeft = e.clientX - offsetX;
                    let newTop = e.clientY - offsetY;

                    newLeft = clamp(
                        newLeft,
                        boardRect.left,
                        boardRect.left + boardRect.width - 200
                    );
                    newTop = clamp(
                        newTop,
                        boardRect.top,
                        boardRect.top + boardRect.height - 200
                    );

                    img.style.left = newLeft + "px";
                    img.style.top = newTop + "px";

                    pin.style.left = (newLeft + 85) + "px";
                    pin.style.top = (newTop - 10) + "px";
                }

                function onMouseUp() {
                    if (!isDragging) return;
                    isDragging = false;

                    item.x = parseInt(img.style.left, 10);
                    item.y = parseInt(img.style.top, 10);
                    saveToStorage();

                    document.removeEventListener("mousemove", onMouseMove);
                    document.removeEventListener("mouseup", onMouseUp);
                }
            }

            addButton.onclick = function () {
                const picNo = parseInt(document.getElementById("pic").value, 10);
                const x = parseInt(document.getElementById("x").value, 10);
                const y = parseInt(document.getElementById("y").value, 10);
                if (isNaN(picNo) || isNaN(x) || isNaN(y)) return;

                addNewPicture(picNo, x, y);
            };

            removeAllButton.onclick = function () {
                for (let i = 0; i < items.length; i++) {
                    const id = items[i].id;
                    const img = document.getElementById("img-" + id);
                    const pin = document.getElementById("pin-" + id);
                    if (img && img.parentNode) img.parentNode.removeChild(img);
                    if (pin && pin.parentNode) pin.parentNode.removeChild(pin);
                }
                items = [];
                saveToStorage();
            };

            loadFromStorage();
        };
    </script>
</head>

<body>
    <img id="board" src="blackboard.jpg" height="720" width="960" style="float:left; z-index:0;" />
    <img id="img-0" class="picture" style="top: 50px; left: 50px; z-index:1;" src="doraemon.png" />
    <img id="pin-0" class="picture" style="top: 40px; left: 135px; z-index:1;" width="30px" src="red.png" />

    <div id="nav" class="nav">
        <form action="#">
            <p>
                <label>要放哪個道具圖片(請輸入編號):
                    <input type="number" id="pic" min="1" max="10" step="1" value="1" />
                </label>
                <br />
                <label>圖片X座標:
                    <input type="number" id="x" min="40" max="600" step="1" value="40" />
                </label>
                <br />
                <label>圖片Y座標:
                    <input type="number" id="y" min="40" max="400" step="1" value="100" />
                </label>
            </p>
            <p>
                <input type="button" value="新增圖片" id="addButton">
                <input type="button" value="移除所有圖片" id="removeAllButton">
            </p>
        </form>
        <ul>
            <li>[01]任意門</li>
            <li>[02]時光機</li>
            <li>[03]竹蜻蜓</li>
            <li>[04]時光布</li>
            <li>[05]記憶麵包</li>
            <li>[06]縮小燈</li>
            <li>[07]翻譯蒟蒻</li>
            <li>[08]如果電話亭</li>
            <li>[09]穿透環</li>
            <li>[10]更衣照相機</li>
        </ul>
    </div>
</body>

</html>
